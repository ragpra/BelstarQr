<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPI Payment QR Code Generator</title>
    <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="manifest" href="./manifest.json"> 
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f7f6;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        button {
            width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px;
            font-size: 16px; cursor: pointer; transition: background-color 0.3s; margin-top: 10px;
        }
        button:hover { background-color: #218838; }
        
        /* Specific Styles for new buttons */
        #shareButton { background-color: #ffc107; color: #333; font-weight: bold; }
        #shareButton:hover { background-color: #e0a800; }
        #resetButton { background-color: #6c757d; }
        #resetButton:hover { background-color: #5a6268; }

        #qrcode-container { text-align: center; margin-top: 25px; min-height: 200px; display: flex; flex-direction: column; align-items: center; }
        #details-container {
            margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; font-size: 14px; display: none; width: 100%; box-sizing: border-box;
        }
        .error { color: #dc3545; font-size: 14px; margin-top: 5px; display: none; }
        #action-buttons { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>UPI Payment QR</h2>
    
    <div class="form-group">
        <label for="loanId">Loan ID:</label>
        <input type="text" id="loanId" placeholder="Enter Loan ID">
        <div id="loanIdError" class="error">Invalid Loan ID. Not found in records.</div>
    </div>

    <div class="form-group">
        <label for="amount">Amount (â‚¹):</label>
        <input type="number" id="amount" placeholder="Enter Amount">
    </div>

    <button onclick="generateQR()">Generate QR Code</button>

    <div id="qrcode-container">
        <canvas id="qrcode"></canvas>
    </div>

    <div id="details-container">
        <strong>Verify Details:</strong>
        <p><strong>Member Name:</strong> <span id="dispMember"></span></p>
        <p><strong>Group Name:</strong> <span id="dispGroup"></span></p>
        <p><strong>Mobile/Nominee:</strong> <span id="dispMobile"></span></p>
        <p><strong>EMI No:</strong> <span id="dispEMI"></span></p>
    </div>

    <div id="action-buttons">
        </div>
</div>

<script>
    let loanData = [];

    // Load CSV for validation
    async function loadLoanData() {
        try {
            const response = await fetch('Dec Demand.xlsx - Sheet1.csv');
            const csvText = await response.text();
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => { loanData = results.data; }
            });
        } catch (error) { console.error("CSV Load Error:", error); }
    }

    function generateQR() {
        const loanIdInput = document.getElementById('loanId').value.trim();
        const amount = document.getElementById('amount').value;
        const errorDiv = document.getElementById('loanIdError');
        const detailsDiv = document.getElementById('details-container');
        const actionButtons = document.getElementById('action-buttons');

        // Validation against Column J (Loan Id)
        const record = loanData.find(row => row['Loan Id'] === loanIdInput);

        if (!record) {
            errorDiv.style.display = 'block';
            detailsDiv.style.display = 'none';
            actionButtons.innerHTML = '';
            return;
        }

        errorDiv.style.display = 'none';
        
        // Generate UPI URL
        const upiUrl = `upi://pay?pa=BelstarQRstat@icici&pn=${record['Member Name']}&am=${amount}&tr=${loanIdInput}&cu=INR`;

        const qr = new QRious({
            element: document.getElementById('qrcode'),
            value: upiUrl,
            size: 200
        });

        // Display Details
        document.getElementById('dispMember').textContent = record['Member Name'] || 'N/A';
        document.getElementById('dispGroup').textContent = record['Group Name'] || 'N/A';
        document.getElementById('dispMobile').textContent = `${record['Mobile '] || 'N/A'} / ${record['Nominee '] || 'N/A'}`;
        document.getElementById('dispEMI').textContent = record['EMI No.'] || 'N/A';
        detailsDiv.style.display = 'block';

        // Add Share and Reset Buttons
        actionButtons.innerHTML = '';
        
        if (navigator.share) {
            const shareBtn = document.createElement('button');
            shareBtn.id = 'shareButton';
            shareBtn.textContent = 'ðŸ–¼ï¸ Share QR Image';
            shareBtn.onclick = () => shareQR(loanIdInput, amount);
            actionButtons.appendChild(shareBtn);
        }

        const resetBtn = document.createElement('button');
        resetBtn.id = 'resetButton';
        resetBtn.textContent = 'ðŸ”„ Reset Field';
        resetBtn.onclick = resetForm;
        actionButtons.appendChild(resetBtn);
    }

    async function shareQR(loanId, amount) {
        const canvas = document.getElementById('qrcode');
        canvas.toBlob(async (blob) => {
            const file = new File([blob], `QR_${loanId}.png`, { type: 'image/png' });
            try {
                await navigator.share({
                    files: [file],
                    title: 'Payment QR',
                    text: `Loan ID: ${loanId} | Amount: â‚¹${amount}`
                });
            } catch (err) { console.error("Share failed", err); }
        });
    }

    function resetForm() {
        document.getElementById('loanId').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('details-container').style.display = 'none';
        document.getElementById('action-buttons').innerHTML = '';
        const canvas = document.getElementById('qrcode');
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    }

    document.addEventListener('DOMContentLoaded', loadLoanData);
</script>

</body>
</html>
