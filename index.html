<script>

    // ... (rest of the resetForm and shareUpiImage functions remain the same) ...

    /**
     * Resets the input fields and clears the QR code area.
     */
    function resetForm() {
        document.getElementById('loanId').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('qrcode-container').innerHTML = '';
        document.getElementById('action-buttons').innerHTML = '';
        document.getElementById('qrcode-container').innerHTML = 'Input required.'; 
    }

    /**
     * Converts the QR code canvas to a file Blob and shares it using the Web Share API.
     * The logic for this function is simplified as QRious always generates a canvas.
     */
    async function shareUpiImage(loanId, cleanAmount) {
        // The QRious library generates a <canvas> directly inside the container.
        const qrCanvasElement = document.getElementById('qrcode-container').querySelector('canvas');
        
        if (!qrCanvasElement) {
            alert('QR Code image not found for sharing.');
            return;
        }
        
        try {
            // 1. Convert the canvas content into a Blob (file object)
            const blob = await new Promise(resolve => {
                qrCanvasElement.toBlob(resolve, 'image/png');
            });

            // 2. Create a File object from the Blob
            const file = new File([blob], `UPI_QR_${loanId}_${cleanAmount}.png`, { type: 'image/png' });

            // 3. Check if the browser can share files
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                
                await navigator.share({
                    files: [file],
                    title: 'UPI Payment QR Code',
                    text: `Scan this QR code to pay for Loan ID: ${loanId} (â‚¹${cleanAmount}).`,
                });
                console.log('UPI QR Image shared successfully!');

            } else {
                // Fallback
                alert("Your browser supports sharing but not file sharing. Please download the QR image and share it manually.");
            }
        } catch (error) {
            console.error('Error sharing UPI QR image:', error);
            if (error.name !== 'AbortError') {
                alert('Could not share image. Check console for details.');
            }
        }
    }


    /**
     * Main function to handle input, create UPI Deep Link, generate QR code, 
     * and set up the download and share buttons.
     */
    function generateQRCode() {
        // 1. Get values from the input fields
        const loanId = document.getElementById('loanId').value.trim();
        const amount = document.getElementById('amount').value.trim();
        const qrContainer = document.getElementById('qrcode-container');
        const actionButtonsContainer = document.getElementById('action-buttons'); 
        
        // **NEW: Define the fixed Payer UPI ID**
        const fixedUpiId = 'BelstarQRstat@icici'; 

        // Basic validation
        if (!loanId || !amount || parseFloat(amount) <= 0) {
            alert("Please enter a valid Loan ID and an amount greater than zero.");
            qrContainer.innerHTML = 'Input required.'; 
            actionButtonsContainer.innerHTML = ''; 
            return;
        }

        // 2. Format the UPI data string
        const cleanAmount = parseFloat(amount).toFixed(2);
        
        const upiLink = 
            `upi://pay?pa=${fixedUpiId}` + // Use the defined UPI ID
            `&pn=${loanId}` + 
            `&tr=MNO${loanId}` + 
            `&am=${cleanAmount}` + 
            `&cu=INR` + 
            `&mc =5411`;
        
        console.log("UPI Deep Link:", upiLink); 
        
        // 3. Clear existing content and create the target canvas element
        qrContainer.innerHTML = '';
        actionButtonsContainer.innerHTML = '';
        
        const canvasElement = document.createElement('canvas');
        canvasElement.id = 'qr-canvas'; // Give it an ID for the QRious library
        qrContainer.appendChild(canvasElement);

        // 4. Generate the new QR code using QRious
        // The QRious library uses a configuration object to define the QR code.
        new QRious({
            element: canvasElement, // Target the canvas element we just created
            value: upiLink,         // The data to encode
            size: 200,              // Size in pixels
            level: 'H',             // Error correction level: H (High)
            padding: 10,            // Padding around the QR code
            foreground: '#000000',  // Dark color
            background: '#ffffff'   // Light color
        });
        
        // --- 5. NEW: Display UPI ID and Loan ID ---
        
        const upiIdMessage = document.createElement('p');
        upiIdMessage.style.fontSize = '0.9em';
        upiIdMessage.style.fontWeight = 'bold';
        upiIdMessage.textContent = `Payer UPI ID: ${fixedUpiId}`;
        qrContainer.appendChild(upiIdMessage);
        
        const loanIdMessage = document.createElement('p');
        loanIdMessage.style.fontSize = '0.9em';
        loanIdMessage.textContent = `Loan ID for Payment: ${loanId}`;
        qrContainer.appendChild(loanIdMessage);
        
        // The original success message, now placed below the details
        const dataMessage = document.createElement('p');
        dataMessage.style.marginTop = '10px';
        dataMessage.textContent = 'UPI QR Code Generated Successfully!';
        qrContainer.appendChild(dataMessage);


        // 6. Add action buttons (Download, Share, Reset)
        
        // --- A. ADD DOWNLOAD BUTTON ---
        // QRious generates a canvas. We get its URL for the download link.
        const imageUrl = canvasElement.toDataURL("image/png");

        const downloadLink = document.createElement('a');
        downloadLink.id = 'downloadLink';
        downloadLink.href = imageUrl;
        downloadLink.download = `UPI_QR_${loanId}_${cleanAmount}.png`; 
        downloadLink.textContent = 'â¬‡ï¸ Download QR Code';
        actionButtonsContainer.appendChild(downloadLink);
        
        // --- B. ADD SHARE IMAGE BUTTON ---
        if (navigator.share) {
            const shareButton = document.createElement('button');
            shareButton.id = 'shareButton';
            shareButton.textContent = 'ðŸ–¼ï¸ Share QR Image';
            shareButton.onclick = () => shareUpiImage(loanId, cleanAmount); 
            actionButtonsContainer.appendChild(shareButton);
        }

        // --- C. ADD RESET BUTTON ---
        const resetButton = document.createElement('button');
        resetButton.id = 'resetButton';
        resetButton.textContent = 'ðŸ”„ Reset Form';
        resetButton.onclick = resetForm; // Call the new reset function
        actionButtonsContainer.appendChild(resetButton);
    }
    
    // Initial message on load
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('qrcode-container').innerHTML = 'Input required.';
        
        // ðŸŸ¢ PWA Addition: Register the Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    });
</script>
