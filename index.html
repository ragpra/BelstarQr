<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPI Payment QR Code Generator</title>
    <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="manifest" href="./manifest.json"> 
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f7f6;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        h2 { text-align: center; color: #333; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        button {
            width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px;
            font-size: 16px; cursor: pointer; transition: background-color 0.3s; margin-top: 10px;
        }
        button:hover { background-color: #218838; }
        #resetButton { background-color: #6c757d; }
        #resetButton:hover { background-color: #5a6268; }
        #qrcode-container { text-align: center; margin-top: 25px; min-height: 200px; }
        #details-container {
            margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; font-size: 14px; display: none;
        }
        .error { color: #dc3545; font-size: 14px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>UPI Payment QR</h2>
    
    <div class="form-group">
        <label for="loanId">Loan ID:</label>
        <input type="text" id="loanId" placeholder="Enter Loan ID">
        <div id="loanIdError" class="error">Invalid Loan ID. Not found in record.</div>
    </div>

    <div class="form-group">
        <label for="amount">Amount (â‚¹):</label>
        <input type="number" id="amount" placeholder="Enter Amount">
    </div>

    <button onclick="generateQR()">Generate QR Code</button>
    <button id="resetButton" onclick="resetForm()">ðŸ”„ Reset Form</button>

    <div id="qrcode-container">
        <canvas id="qrcode"></canvas>
    </div>

    <div id="details-container">
        <strong>Verify Details:</strong>
        <p><strong>Member Name:</strong> <span id="dispMember"></span></p>
        <p><strong>Group Name:</strong> <span id="dispGroup"></span></p>
        <p><strong>Mobile/Nominee:</strong> <span id="dispMobile"></span></p>
        <p><strong>EMI No:</strong> <span id="dispEMI"></span></p>
    </div>
</div>

<script>
    let loanData = [];

    // Load and Parse the CSV file on startup
    async function loadLoanData() {
        try {
            const response = await fetch('Sheet1.csv');
            const csvText = await response.text();
            
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    loanData = results.data;
                    console.log("Loan database loaded.");
                }
            });
        } catch (error) {
            console.error("Error loading CSV:", error);
        }
    }

    function generateQR() {
        const loanIdInput = document.getElementById('loanId').value.trim();
        const amount = document.getElementById('amount').value;
        const errorDiv = document.getElementById('loanIdError');
        const detailsDiv = document.getElementById('details-container');

        [span_4](start_span)// Validation against Column J (Loan Id)[span_4](end_span)
        const record = loanData.find(row => row['Loan Id'] === loanIdInput);

        if (!record) {
            errorDiv.style.display = 'block';
            detailsDiv.style.display = 'none';
            document.getElementById('qrcode').style.visibility = 'hidden';
            return;
        }

        errorDiv.style.display = 'none';
        
        // Generate UPI URL (Standard format)
        const upiUrl = `upi://pay?pa=your-vpa@bank&pn=Merchant&am=${amount}&tr=${loanIdInput}&cu=INR`;

        // Create QR
        const qr = new QRious({
            element: document.getElementById('qrcode'),
            value: upiUrl,
            size: 200
        });
        document.getElementById('qrcode').style.visibility = 'visible';

        [span_5](start_span)[span_6](start_span)[span_7](start_span)// Display Fetched Details: Group Name, Member Name, Mobile/Nominee, EMI No.[span_5](end_span)[span_6](end_span)[span_7](end_span)
        document.getElementById('dispMember').textContent = record['Member Name'] || 'N/A';
        document.getElementById('dispGroup').textContent = record['Group Name'] || 'N/A';
        document.getElementById('dispMobile').textContent = `${record['Mobile '] || 'N/A'} / ${record['Nominee '] || 'N/A'}`;
        document.getElementById('dispEMI').textContent = record['EMI No.'] || 'N/A';
        
        detailsDiv.style.display = 'block';
    }

    function resetForm() {
        document.getElementById('loanId').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('loanIdError').style.display = 'none';
        document.getElementById('details-container').style.display = 'none';
        const canvas = document.getElementById('qrcode');
        const context = canvas.getContext('2d');
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Initialize data load
    document.addEventListener('DOMContentLoaded', loadLoanData);
</script>

</body>
</html>
