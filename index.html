    /**
     * Main function to handle input, create UPI Deep Link, generate QR code, 
     * and set up the download and share buttons.
     */
    function generateQRCode() {
        // 1. Get values from the input fields
        const loanId = document.getElementById('loanId').value.trim();
        const amount = document.getElementById('amount').value.trim();
        const qrContainer = document.getElementById('qrcode-container');
        const actionButtonsContainer = document.getElementById('action-buttons'); 
        
        // Define the fixed Payer UPI ID
        const fixedUpiId = 'BelstarQRstat@icici'; 
        
        // 2. Input Validation 
        
        const numericAmount = parseFloat(amount); // Convert to number once

        // Check 1: Ensure Loan ID and Amount fields are not empty
        if (!loanId || !amount) {
            alert("Please enter both a valid Loan ID and an amount.");
            qrContainer.innerHTML = 'Input required.'; 
            actionButtonsContainer.innerHTML = ''; 
            return;
        }

        // Check 2: NEW/REFINED AMOUNT VALIDATION
        if (isNaN(numericAmount) || numericAmount <= 0) {
            alert("The Payment Amount must be a valid number greater than zero.");
            qrContainer.innerHTML = 'Input required.'; 
            actionButtonsContainer.innerHTML = ''; 
            return;
        }

        // Check 3: Loan ID length check (at least 12 digits)
        if (loanId.length < 12) {
            alert("The Loan ID must be at least 12 digits long.");
            qrContainer.innerHTML = 'Input required.'; 
            actionButtonsContainer.innerHTML = ''; 
            return;
        }
        
        // 3. Format the UPI data string
        const cleanAmount = numericAmount.toFixed(2); // Use the parsed number
        
        const upiLink = 
            `upi://pay?pa=${fixedUpiId}` + 
            `&pn=${loanId}` + 
            `&tr=MNO${loanId}` + 
            `&am=${cleanAmount}` + 
            `&cu=INR` + 
            `&mc =5411`;
        
        console.log("UPI Deep Link:", upiLink); 
        
        // 4. Clear existing content and create the target canvas element
        // ... (QR code generation logic remains the same) ...
        qrContainer.innerHTML = '';
        actionButtonsContainer.innerHTML = '';
        
        const canvasElement = document.createElement('canvas');
        canvasElement.id = 'qr-canvas'; 
        qrContainer.appendChild(canvasElement);

        new QRious({
            element: canvasElement,
            value: upiLink,         
            size: 200,              
            level: 'H',             
            padding: 10,            
            foreground: '#000000',  
            background: '#ffffff'   
        });
        
        // Display UPI ID and Loan ID
        const upiIdMessage = document.createElement('p');
        upiIdMessage.style.fontSize = '0.9em';
        upiIdMessage.style.fontWeight = 'bold';
        upiIdMessage.textContent = `Payer UPI ID: ${fixedUpiId}`;
        qrContainer.appendChild(upiIdMessage);
        
        const loanIdMessage = document.createElement('p');
        loanIdMessage.style.fontSize = '0.9em';
        loanIdMessage.textContent = `Loan ID for Payment: ${loanId}`;
        qrContainer.appendChild(loanIdMessage);
        
        const dataMessage = document.createElement('p');
        dataMessage.style.marginTop = '10px';
        dataMessage.textContent = 'UPI QR Code Generated Successfully!';
        qrContainer.appendChild(dataMessage);


        // 5. Add action buttons (Download, Share, Reset)
        // ... (Button logic remains the same) ...
        const imageUrl = canvasElement.toDataURL("image/png");

        const downloadLink = document.createElement('a');
        downloadLink.id = 'downloadLink';
        downloadLink.href = imageUrl;
        downloadLink.download = `UPI_QR_${loanId}_${cleanAmount}.png`; 
        downloadLink.textContent = 'â¬‡ï¸ Download QR Code';
        actionButtonsContainer.appendChild(downloadLink);
        
        if (navigator.share) {
            const shareButton = document.createElement('button');
            shareButton.id = 'shareButton';
            shareButton.textContent = 'ðŸ–¼ï¸ Share QR Image';
            shareButton.onclick = () => shareUpiImage(loanId, cleanAmount); 
            actionButtonsContainer.appendChild(shareButton);
        }

        const resetButton = document.createElement('button');
        resetButton.id = 'resetButton';
        resetButton.textContent = 'ðŸ”„ Reset Form';
        resetButton.onclick = resetForm; 
        actionButtonsContainer.appendChild(resetButton);
    }
